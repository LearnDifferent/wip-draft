<template>
  <div>
    <!-- 切换搜索模式 -->
    <v-tabs
        fixed-tabs
        background-color="#474a4d"
        color="white"
        slider-color="#e0ebaf"
    >
      <v-tab class="text-none" @click="changeSearchMode('web')">
        <v-icon left>
          mdi-file-find
        </v-icon>
        Search Websites
      </v-tab>
      <v-tab class="text-none" @click="changeSearchMode('user')">
        <v-icon left>
          mdi-account-search
        </v-icon>
        Search Users
      </v-tab>
    </v-tabs>

    <v-container fill-height>

      <!-- 网页相关的选项提示等 -->
      <!-- 提示更新网页搜索的数据库 -->
      <v-btn v-show="hasNewUpdate && hasDb && searchMode!== 'user'"
             class="text-none"
             block
             color="orange"
             outlined
             rounded
             @click="genDb">
        <v-icon>mdi-cached</v-icon>
        <span>Update Search Engine</span>
      </v-btn>

      <!-- 没有网页数据的时候，提示生成数据 -->
      <div v-show="!hasDb && searchMode!== 'user'">
        <v-alert
            prominent
            type="error"
        >
          <v-row align="center">
            <v-col class="grow">
              The Search-Engine Database has no data for searching.
              You will NOT get any search results unless you
              Generate the Database.
              Please <a href="javascript:void(0)" @click="genDb" style="color: aliceblue">click here</a> or the right
              button to Generate the Database.
            </v-col>
            <v-col class="shrink">
              <v-btn class="text-none" @click="genDb">Generate</v-btn>
            </v-col>
          </v-row>
        </v-alert>
      </div>

      <!-- 搜索网页时的更多选项 -->
      <div v-show="searchMode === 'web'" style="margin-top: 1%">
        <v-btn
            class="mx-2"
            color="#808080"
            dark
            small
            fab
            @click="hidden = !hidden"
        >
          <v-icon dark>
            {{ hidden ? 'mdi-cog' : 'mdi-close' }}
          </v-icon>
        </v-btn>
        <v-fab-transition
            v-for="tile in tiles"
        >
          <v-btn
              class="text-none"
              :key="tile.title"
              v-show="!hidden"
              rounded
              outlined
              @click="moreOptions(tile.tId)"
          >
            <v-icon
                left
                :color="tile.color"
            >
              {{ tile.icon }}
            </v-icon>
            {{ tile.title }}
          </v-btn>
        </v-fab-transition>

        <!-- 显示热搜 -->
        <v-btn
            class="mx-2"
            color="red"
            dark
            small
            fab
            @click="showTrending =! showTrending"
        >
          <v-icon dark>
            {{ showTrending ? 'mdi-fire' : 'mdi-close' }}
          </v-icon>
        </v-btn>
      </div>



      <!-- 进度条 -->
      <v-progress-linear
          v-show="processing"
          color="#b35c44"
          indeterminate
          rounded
          height="30px"
      >
        <div style="size: 20px">{{ processing }}</div>
      </v-progress-linear>

      <!--搜索框-->
      <v-row style="margin-top: 1%">
        <v-col>
          <v-text-field
              id="inputField"
              v-model="inputMsg"
              :append-icon="inputMsg ? 'mdi-magnify' : ''"
              :label="placeholderMsg ? 'Searching：'+placeholderMsg:''"
              single-line
              outlined
              clearable
              @keyup.enter="searchRequest(inputMsg, currentPage)"
              @click:append="searchRequest(inputMsg, currentPage)"
          ></v-text-field>
          <p v-show="totalCount !== -1 && !errorMsg">
            Total {{ totalCount >= 1 ? totalCount : 0 }} result{{ totalCount > 1 ? 's' : '' }}
          </p>
          <p v-show="errorMsg" style="color: red">{{ errorMsg }}</p>
        </v-col>
      </v-row>

      <v-progress-linear
          v-show="isSearching"
          color="orange"
          indeterminate
          rounded
          height="30px"
      >
        <div style="size: 20px">Searching....</div>
      </v-progress-linear>

      <!-- 网页热搜数据 -->
      <div class="text-center" v-show="this.showTrending && searchMode !== 'user'">
        <v-row>
          <v-col
              class="text-center"
              v-for="(trend, i) in trending"
              :key="i"
              cols="20"
              v-show="trending"
          >
            <v-chip
                v-show="i < 6"
                class="ma-2"
                color="#dc3023"
                text-color="white"
                @click="searchRequest(trend, currentPage)"
            >
              {{ trend }}
              <v-icon right @click.stop="delTrend(trend, i)">
                mdi-close
              </v-icon>
            </v-chip>

            <v-chip
                v-show="6 <= i && i <= 12"
                class="ma-2"
                color="#f35336"
                text-color="white"
                @click="searchRequest(trend, currentPage)"
            >
              {{ trend }}
              <v-icon right @click.stop="delTrend(trend)">
                mdi-close
              </v-icon>
            </v-chip>

            <v-chip
                v-show="i > 12"
                class="ma-2"
                color="#ea5506"
                text-color="white"
                @click="searchRequest(trend, currentPage)"
            >
              {{ trend }}
              <v-icon right @click.stop="delTrend(trend)">
                mdi-close
              </v-icon>
            </v-chip>

          </v-col>
        </v-row>
      </div>

      <v-container class="mx-auto">
        <!-- 搜索结果 -->
        <v-row dense>
          <v-col
              v-for="(item, i) in items"
              :key="i"
              cols="12"
          >
            <!-- 用户搜索结果 -->
            <v-card v-show="searchMode==='user'">
              <UserInfoList :user="item" v-show="searchMode==='user'"></UserInfoList>
            </v-card>

            <!-- 网页搜索结果 -->
            <v-card v-show="searchMode==='web'">
              <div class="d-flex flex-no-wrap justify-space-between">
                <div>
                  <v-card-title
                      class="headline"
                      v-html="item.title"
                      @click="jump(item.url)"
                  ></v-card-title>

                  <v-card-subtitle v-html="item.desc" @click="jump(item.url)"></v-card-subtitle>
                </div>

                <v-avatar
                    class="ma-3"
                    size="125"
                    tile
                    @click="jump(item.url)"
                >
                  <v-img :src="item.img"></v-img>
                </v-avatar>
              </div>
            </v-card>
          </v-col>
        </v-row>

        <!--分页-->
        <v-row v-show="currentPage > 0 && totalCount > 0" align-content="center">
          <v-col>
            <v-pagination
                v-model="currentPage"
                :length="totalPage"
                circle
                @input="changePage(keyword, currentPage)"
            ></v-pagination>
          </v-col>
        </v-row>

      </v-container>
    </v-container>
  </div>
</template>

<script>
import UserInfoList from "../component/UserInfoList";

export default {
  components: {UserInfoList},
  name: "Find",
  data: () => ({
    // 是否隐藏更多选项
    hidden: true,
    inputMsg: '',
    placeholderMsg: '',
    // 关键词
    keyword: '',
    // 错误信息
    errorMsg: '',
    // 总数
    totalCount: -1,
    // 分页
    currentPage: 0,
    totalPage: 1,
    // 当前用户
    currentUser: '',
    // 网页数据
    items: '',
    // 热搜
    trending: '',
    // 是否显示热搜
    showTrending: true,
    // 是否正在搜索
    isSearching: false,
    // 操作搜索数据库相关
    tiles: [
      {
        title: 'Delete All Trending Tags',
        tId: 'tags',
        icon: 'mdi-tag-off-outline',
        color: 'red lighten-1'
      },
      {
        title: 'Generate (Update) Search-Engine Database',
        tId: 'gen',
        icon: 'mdi-database-refresh',
        color: 'green darken-2'
      },
      {
        title: 'Delete Search-Engine Database',
        tId: 'del',
        icon: 'mdi-database-remove',
        color: 'red darken-2'
      },
    ],
    // 是否有数据库
    hasDb: true,
    // 是否有新的更新
    hasNewUpdate: false,
    // 正在进行搜索数据库相关操作
    processing: '',
    // search mode
    searchMode: 'web'
  }),
  methods: {

    // 切换搜索模式
    changeSearchMode(searchMode) {
      // 切换模式
      this.searchMode = searchMode;
      // 重置数据
      this.items = '';
      this.hidden = true;
      this.inputMsg = '';
      this.placeholderMsg = '';
      this.keyword = '';
      this.errorMsg = '';
      this.totalCount = -1;
      this.currentPage = 0;
      this.totalPage = 1;
      this.isSearching = false;
    },

    // 删除某个热搜词
    delTrend(word, arrayIndex) {
      if (confirm("Delete this Trending Tag?")) {
        this.axios.delete("/find/trends/" + word).then(res => {
          if (res.data === true) {
            alert("Deleted");
            this.trending.splice(arrayIndex, 1);
          } else {
            alert("Can't delete it...");
          }
        }).catch(error => {
          if (error.response.data.code === 2009) {
            alert("You are now Login as Guest and Guest can't delete this tag.\n\n" +
                "Please Login as Normal User or Admin to delete.");
          } else {
            alert("Something went wrong. Please try again later.")
          }
        });
      }
    },
    // 删除所有热搜标签
    delAllTrending() {
      // this.dialog3 = false;
      this.processing = 'Delete All Trending Tags.... Please wait a minute.';
      this.axios.delete("/find/trends").then(res => {
        if (res.data === true) {
          alert("Deleted");
          this.trending = '';
        } else {
          alert("Already Deleted");
        }
      }).catch(error => {
        if (error.response.data.code === 2009) {
          alert("You are now Login as Guest and Guest can't delete tags.\n\n" +
              "Please Login as Normal User or Admin to delete.");
        } else {
          alert("Something went wrong. Please try again later.");
        }
      }).finally(() => {
        this.processing = '';
      });
    },
    // 更多操作（打开生成/删除搜索数据库的按钮等）
    moreOptions(tId) {
      if (tId === 'del') {
        if (confirm("Are you sure you want to Delete Search-Engine Database?")) {
          this.delDb();
        }
      }
      if (tId === 'gen') {
        if (confirm("Are you sure you want to Generate (Update) Search-Engine Database?")) {
          this.genDb();
        }
      }
      if (tId === 'tags') {
        if (confirm("Are you sure you want to Delete All Trending Tags?")) {
          this.delAllTrending();
        }
      }
      // 最后，让按钮恢复正常
      let btn = document.getElementById("myFindBtn");
      btn.click();
    },
    // 删除搜索数据库
    delDb() {
      this.processing = 'Deleting The Search-Engine Database.... Please wait a minute.';
      this.axios.delete("/find/build").then(res => {
        if (res.data == true) {
          alert("Deleted");
          this.hasDb = false;
        } else {
          alert("Something went wrong. Please try again.")
        }
        this.processing = '';
      }).catch(error => {
        if (error.response.data.code === 5001) {
          this.processing = '';
          // 5001 表示网络异常
          alert(error.response.data.msg);
        }
      });
    },
    // 生成搜索数据库操作
    genDb() {
      this.hasNewUpdate = false;
      this.processing = 'Generating The Search-Engine Database... Please wait a minute.';
      this.axios.get("/find/build?mode=web").then(res => {
        if (res.data == true) {
          alert("Success!");
          this.hasDb = true;
        } else {
          alert("Something went wrong. Please try again.")
        }
        this.processing = '';
      }).catch(error => {
        if (error.response.data.code === 5001) {
          this.processing = '';
          // 5001 表示网络异常
          alert(error.response.data.msg);
        }
      });
    },
    // 跳转页面
    jump(url) {
      window.open(url, '_blank')
    },
    changePage(keyword, currentPage) {
      var keyword = keyword;
      var currentPage = currentPage;
      this.searchRequest(keyword, currentPage);

      // 让页面返回顶部
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    },
    searchRequest(keyword, currentPage) {
      if (keyword.trim() === '') {
        alert("Please enter something...");
      } else if (!this.hasDb && this.searchMode === 'web') {
        // 如果数据库中没有数据，且 search mode 为 web，就提示：
        alert("No Data to Search. Please Generate Search-Engine Database.")
      } else {
        if (this.keyword !== keyword) {
          currentPage = 1;
          this.currentPage = currentPage;
        }

        // 进行搜索的时候，不显示热搜
        this.showTrending = false;
        // 正在进行搜索
        this.isSearching = true;

        // 重新搜索的时候，删除错误信息
        this.errorMsg = '';

        this.axios.get("/find/search", {
          params: {
            "currentPage": currentPage,
            "keyword": keyword,
            "mode": this.searchMode
          }
        }).then(resp => {
          this.items = resp.data.data.paginatedResults;
          this.totalPage = resp.data.data.totalPage;
          let totalCount = resp.data.data.totalCount;
          if (totalCount === 0 || !totalCount) {
            // 没有搜索结果的时候，显示热搜
            this.showTrending = true;
          }
          this.totalCount = totalCount;
          this.keyword = keyword;
          let inputField = document.getElementById("inputField");
          inputField.blur();
          // 搜索结束
          this.isSearching = false;
        }).catch(error => {
          this.processing = '';
          this.errorMsg = error.response.data.msg;
          this.isSearching = false;
        });

        this.clearMessage(keyword);
      }
    },
    clearMessage(keyword) {
      this.placeholderMsg = keyword
      this.inputMsg = ''
    },
    load() {
      this.axios.get("/find/load").then(res => {
        this.trending = res.data.data.trendingList;
        this.hasDb = res.data.data.dataStatus;
        this.hasNewUpdate = res.data.data.hasNewUpdate;
      }).catch((error) => {
        if (error.response.data.code === 2005) {
          this.$router.push("/login")
        } else if (error.response.data.code === 5001) {
          alert("Unable to connect to Search Engine.");
        } else {
          alert("Something went wrong. Can't load this page.")
        }
      });
    }
  },
  created() {
    window.onload = function () {
      document.getElementById("myFindBtn").click();
    }
    this.load();
  }
}
</script>

<style scoped>
</style>
